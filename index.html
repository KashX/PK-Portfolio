<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Circular Portfolio</title>
    <!-- Tailwind CSS for UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- All CSS is now defined here -->
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Inter', sans-serif; 
            background-color: #1a1a2e; 
        }
        canvas { 
            display: block; 
        }
    </style>
    
    <!-- External Libraries (THREE.js and GLTFLoader) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

</head>
<body>

    <!-- 2D UI Overlay -->
    <div id="ui-container" class="absolute inset-0 z-10 pointer-events-none">

        <!-- Initial Enter Screen -->
        <div id="enter-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900/90 backdrop-blur-sm transition-opacity duration-1000">
            <h1 class="text-4xl sm:text-6xl font-extrabold text-white mb-6 animate-pulse">
                [ My 3D Portfolio ]
            </h1>
            <p id="loading-status" class="text-white text-lg mb-4">Loading models... 0%</p>
            <button id="enter-button" disabled class="px-8 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-2xl transition-all duration-300 transform pointer-events-auto text-xl opacity-50 cursor-not-allowed">
                Enter World
            </button>
        </div>
        
        <!-- Instructions -->
        <div id="instructions" class="fixed bottom-0 right-0 p-4 text-xs sm:text-sm text-white bg-black/50 rounded-tl-xl hidden">
            <span class="font-bold text-indigo-400">Controls:</span> Scroll Wheel to Rotate
        </div>
    </div>

    <!-- Three.js will render into the body -->

    <!-- Main application script -->
    <script>
        // =======================================================================
        // I. CONFIGURATION AND GLOBAL STATE
        // =======================================================================

        // --- Model URLS (Set to RAW GitHub content link) ---
        const BASE_URL = 'https://raw.githubusercontent.com/KashX/PK-Portfolio/main/models/';
        const CACHE_BUST = new Date().getTime(); 
        // Adding cache-buster to force the browser to check for the latest file
        const ENVIRONMENT_URL = BASE_URL + 'Environment.glb?v=' + CACHE_BUST;
        const TRAIN_URL = BASE_URL + 'Train.glb?v=' + CACHE_BUST;
        
        // --- 3D Scene Constants ---
        const MODEL_SCALE = 30; // Scale factor for the imported GLB models
        const CAMERA_DISTANCE = 500;  // Distance from the center of the scene
        const ROTATION_FACTOR = 0.0002; // Sensitivity of the scroll rotation
        
        // --- Global Variables ---
        let scene, camera, renderer, environmentGroup; // environmentGroup holds all rotating elements
        let isGameActive = false;
        
        // --- Loading State ---
        let modelsLoaded = false;
        const totalModels = 2; // Now loading Environment and Train
        let loadedCount = 0;

        // --- DOM Elements ---
        const enterScreen = document.getElementById('enter-screen');
        const enterButton = document.getElementById('enter-button');
        const loadingStatus = document.getElementById('loading-status');
        const instructions = document.getElementById('instructions');
        
        // GLTF Loader instance
        const loader = new THREE.GLTFLoader();

        // =======================================================================
        // II. UTILITY FUNCTIONS (Loading and UI)
        // =======================================================================

        function updateLoadingProgress(isFallback = false) {
            loadedCount++;
            const percent = Math.floor((loadedCount / totalModels) * 100);
            loadingStatus.textContent = isFallback 
                ? `Loaded (${percent}%). Using fallback geometry.`
                : `Loading models... ${percent}%`;
            
            if (loadedCount === totalModels) {
                modelsLoaded = true;
                loadingStatus.textContent = isFallback 
                    ? `Loading complete! Using fallback geometry.`
                    : `Loading complete!`;
                enterButton.disabled = false;
                enterButton.classList.remove('opacity-50', 'cursor-not-allowed');
                enterButton.classList.add('hover:bg-indigo-500', 'hover:scale-105');
            }
        }

        function loadModel(path, successCallback, fallbackCreator) {
            loader.load(path, (gltf) => {
                successCallback(gltf.scene);
                updateLoadingProgress(false);
            }, (xhr) => {
                // Progress tracking (optional)
            }, (error) => {
                console.error(`Error loading model from ${path}. Falling back to default geometry.`, error);
                fallbackCreator();
                updateLoadingProgress(true); 
            });
        }

        function createDefaultEnvironment() {
            // Fallback to a simple, clearly visible cylinder
            const geometry = new THREE.CylinderGeometry(50, 50, 50, 32);
            const material = new THREE.MeshLambertMaterial({ color: 0x34d95b }); 
            const fallbackMesh = new THREE.Mesh(geometry, material);
            fallbackMesh.receiveShadow = true;
            fallbackMesh.castShadow = true;
            
            environmentGroup.add(fallbackMesh);
        }

        function createDefaultTrain() {
            // Fallback to a simple cube for the train
            const geometry = new THREE.BoxGeometry(15, 15, 15);
            const material = new THREE.MeshLambertMaterial({ color: 0xff4d4d }); // Red color
            const fallbackMesh = new THREE.Mesh(geometry, material);
            fallbackMesh.position.y = 25; // Lift slightly above the center plane
            fallbackMesh.receiveShadow = true;
            fallbackMesh.castShadow = true;

            environmentGroup.add(fallbackMesh);
        }


        function initEnvironmentModel(model) {
            if (model) {
                // Apply scale and setup shadows for the loaded GLB model
                model.scale.set(MODEL_SCALE, MODEL_SCALE, MODEL_SCALE);
                model.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });
                environmentGroup.add(model);
            } else {
                // If model failed to load, use the fallback
                createDefaultEnvironment();
            }
        }

        function initTrainModel(model) {
            if (model) {
                // Apply scale and setup shadows for the loaded GLB model
                // Note: Train scale might need individual adjustment
                model.scale.set(MODEL_SCALE, MODEL_SCALE, MODEL_SCALE); 
                model.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });
                environmentGroup.add(model);
            } else {
                // If model failed to load, use the fallback
                createDefaultTrain();
            }
        }

        // =======================================================================
        // III. 3D SCENE SETUP
        // =======================================================================

        function init() {
            // --- Scene ---
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e); // Dark background

            // --- Rotation Group Initialization ---
            // This group is added early so we can add models to it during loading
            environmentGroup = new THREE.Group();
            scene.add(environmentGroup);
            // Set initial rotation (45 degrees) to match camera angle
            environmentGroup.rotation.y = Math.PI / 4;

            // --- Camera ---
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            // Fixed position for 45-degree down tilt view
            camera.position.set(
                CAMERA_DISTANCE, 
                CAMERA_DISTANCE * 0.6, // Looking down
                CAMERA_DISTANCE
            );
            // Adjusted lookAt to center the view better
            camera.lookAt(0, 0, 0); 
            
            // --- Renderer ---
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // --- Lighting ---
            scene.add(new THREE.AmbientLight(0x404040, 5)); 

            const directionalLight = new THREE.DirectionalLight(0xffffff, 3);
            directionalLight.position.set(200, 300, 200);
            directionalLight.target.position.set(0, 0, 0);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // --- Load Models ---
            loadModel(ENVIRONMENT_URL, initEnvironmentModel, createDefaultEnvironment); 
            loadModel(TRAIN_URL, initTrainModel, createDefaultTrain); 

            // --- Event Listeners ---
            window.addEventListener('resize', onWindowResize);
            enterButton.addEventListener('click', handleEnter);
            window.addEventListener('wheel', onMouseWheel);
        }

        // =======================================================================
        // IV. EVENT HANDLERS AND GAME LOOP
        // =======================================================================

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onMouseWheel(event) {
            if (!isGameActive || !environmentGroup) return;

            // Prevent page scrolling when interacting with the 3D scene
            event.preventDefault(); 

            // Rotate the environment group (containing both environment and train)
            // event.deltaY is positive for scrolling down (forward rotation)
            const scrollRotation = event.deltaY * ROTATION_FACTOR;
            environmentGroup.rotation.y += scrollRotation;
        }

        function handleEnter() {
            if (!modelsLoaded) return;
            
            // Hide the enter screen UI and show instructions
            enterScreen.style.opacity = '0';
            setTimeout(() => {
                enterScreen.style.display = 'none';
                instructions.classList.remove('hidden');
                isGameActive = true;
            }, 1000);
        }

        function animate() {
            requestAnimationFrame(animate);

            // REMOVED: Continuous rotation logic. 
            // Rotation is now purely driven by the 'onMouseWheel' event handler.

            renderer.render(scene, camera);
        }

        // --- Initialization ---
        window.onload = function () {
            init();
            animate(); 
        };
    </script>
</body>
</html>