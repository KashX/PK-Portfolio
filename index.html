<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Circular Portfolio</title>
    <!-- Tailwind CSS for UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background-color: #1a1a2e; }
        canvas { display: block; }
        /* Style for the scroll container if needed, though we are using the window scroll */
    </style>
    
    <!-- Load THREE.js and GLTFLoader using standard script tags (non-module) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

</head>
<body>

    <!-- 2D UI Overlay (Enter Screen, Loading) -->
    <div id="ui-container" class="absolute inset-0 z-10 pointer-events-none">

        <!-- Initial Enter Screen -->
        <div id="enter-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900/90 backdrop-blur-sm transition-opacity duration-1000">
            <h1 class="text-4xl sm:text-6xl font-extrabold text-white mb-6 animate-pulse">
                [ My 3D Portfolio ]
            </h1>
            <p id="loading-status" class="text-white text-lg mb-4">Loading environment model... 0%</p>
            <button id="enter-button" disabled class="px-8 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-2xl transition-all duration-300 transform pointer-events-auto text-xl opacity-50 cursor-not-allowed">
                Enter World
            </button>
        </div>
    </div>

    <!-- Three.js will render into the body -->

    <!-- Main application script -->
    <script>
        // --- Firebase/Auth Setup (Mandatory Globals Check) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        console.log(`App ID: ${appId}. Firebase Config Status: ${firebaseConfig ? 'Loaded' : 'Missing'}.`);
        // --------------------------------------------------------

        // --- MODEL URLS (Set to RAW GitHub content link) ---
        const BASE_URL = 'https://raw.githubusercontent.com/KashX/PK-Portfolio/main/models/';
        const ENVIRONMENT_URL = BASE_URL + 'Environment.glb';
        // -------------------------------------------------------------

        let scene, camera, renderer, environmentGroup;
        let isGameActive = false;
        let cameraAnimationProgress = 0;
        
        const ENVIRONMENT_SCALE = 15; // Scaling factor for the imported model
        
        let modelsLoaded = false;
        const totalModels = 1;
        let loadedCount = 0;

        // UI elements
        const enterScreen = document.getElementById('enter-screen');
        const enterButton = document.getElementById('enter-button');
        const loadingStatus = document.getElementById('loading-status');
        
        // GLTF Loader instance
        const loader = new THREE.GLTFLoader();

        // --- Model Loading Helpers ---

        function updateLoadingProgress(isFallback = false) {
            loadedCount++;
            const percent = Math.floor((loadedCount / totalModels) * 100);
            loadingStatus.textContent = isFallback 
                ? `Loaded (${percent}%). Using fallback geometry.`
                : `Loading environment model... ${percent}%`;
            
            if (loadedCount === totalModels) {
                modelsLoaded = true;
                loadingStatus.textContent = isFallback 
                    ? `Loading complete! Using fallback geometry.`
                    : `Loading complete!`;
                enterButton.disabled = false;
                enterButton.classList.remove('opacity-50', 'cursor-not-allowed');
                enterButton.classList.add('hover:bg-indigo-500', 'hover:scale-105');
            }
        }

        function loadModel(path, successCallback, fallbackCreator) {
            
            loader.load(path, (gltf) => {
                successCallback(gltf.scene);
                updateLoadingProgress(false);
            }, (xhr) => {
                // Progress tracking: (xhr.loaded / xhr.total) * 100 + '% loaded'
            }, (error) => {
                console.error(`Error loading model from ${path}. Falling back to default geometry.`, error);
                fallbackCreator();
                updateLoadingProgress(true); // Mark as loaded with fallback status
            });
        }

        // --- Core 3D Setup ---

        function createDefaultEnvironment() {
            // Fallback to a simple cylinder
            const geometry = new THREE.CylinderGeometry(50, 50, 50, 32);
            const material = new THREE.MeshLambertMaterial({ color: 0x6c63ff }); 
            const fallbackMesh = new THREE.Mesh(geometry, material);
            fallbackMesh.receiveShadow = true;
            fallbackMesh.castShadow = true;
            
            // Add the fallback mesh directly to the group
            environmentGroup.add(fallbackMesh);
        }

        function initEnvironment(model) {
            
            // Create a central group to hold and rotate the model
            environmentGroup = new THREE.Group();
            scene.add(environmentGroup);

            // Check if a model was loaded successfully
            if (model) {
                
                // Set scale and add to group
                model.scale.set(ENVIRONMENT_SCALE, ENVIRONMENT_SCALE, ENVIRONMENT_SCALE);
                model.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });
                environmentGroup.add(model);
                
            } else {
                // If model failed to load, use the fallback
                createDefaultEnvironment();
            }

            // Set initial rotation to make it visible right away
            environmentGroup.rotation.y = Math.PI / 4;
        }


        function init() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e); // Dark background

            // Camera
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            // Fixed 45-degree down tilt view
            const cameraDistance = 200;
            camera.position.set(cameraDistance, cameraDistance * 0.7, cameraDistance);
            camera.lookAt(0, 0, 0); 
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 5); // soft white light
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 3);
            directionalLight.position.set(200, 300, 200);
            directionalLight.target.position.set(0, 0, 0);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);

            // Load the environment model (success or failure triggers modelLoaded flag)
            loadModel(ENVIRONMENT_URL, initEnvironment, createDefaultEnvironment); 

            // Event Listeners
            window.addEventListener('resize', onWindowResize);
            enterButton.addEventListener('click', handleEnter);
            
            // Add scroll listener for rotation
            window.addEventListener('wheel', onMouseWheel);
        }

        // --- Event Handlers ---

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onMouseWheel(event) {
            if (!isGameActive || !environmentGroup) return;

            // Prevent page scrolling when interacting with the 3D scene
            event.preventDefault(); 

            // Determine rotation speed and direction
            // event.deltaY is positive for scrolling down (typically)
            const rotationSpeed = event.deltaY * 0.001;
            
            // Rotate the environment group around the Y-axis
            environmentGroup.rotation.y += rotationSpeed;
        }

        function handleEnter() {
            if (!modelsLoaded) return;
            
            // Hide the enter screen UI
            enterScreen.style.opacity = '0';
            setTimeout(() => {
                enterScreen.style.display = 'none';
                isGameActive = true;
            }, 1000);
        }

        // --- Animation Loop ---

        function animate() {
            requestAnimationFrame(animate);

            if (isGameActive) {
                // No continuous rotation needed, rotation is handled by scroll
            }
            
            renderer.render(scene, camera);
        }

        // Initialize on load
        window.onload = function () {
            init();
            // Start the loop immediately
            animate(); 
        };
    </script>
</body>
</html>